<!DOCTYPE html>
<html lang="en" data-content_root="../../../"
  x-data="{ darkMode: $persist(window.matchMedia('(prefers-color-scheme: dark)').matches), activeSection: ''}"
  :class="{ 'dark' : darkMode === true }">

<head>
  <script>
    (function () {
      // Set initial color scheme
      if ((localStorage.getItem("_x_darkMode") === "true") || (window.matchMedia("(prefers-color-scheme: dark)").matches)) {
        document.documentElement.classList.add("dark");
      }

      // Watch for media preference changes
      window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (event) => {
        localStorage.setItem("_x_darkMode", event.matches);
        document.documentElement.classList.toggle("dark", event.matches);
      });
    })();
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="utf-8" />
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#030711" />
  
  <title>stable_datasets.utils | stable-datasets</title>
  <meta property="og:title" content="stable_datasets.utils | stable-datasets" />
  <meta name="twitter:title" content="stable_datasets.utils | stable-datasets" />
  <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=3efa2d9f" />
  <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="../../../_static/pygments_dark.css" />
  <link rel="stylesheet" type="text/css" href="../../../_static/theme.css?v=73505e79" />
  <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/fontawesome.min.css" />
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/solid.min.css" />
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/brands.min.css" />
  <link rel="stylesheet" type="text/css" href="../../../_static/awesome-sphinx-design.css?v=c54898a4" />
  <link rel="search" title="Search" href="../../../search/" />
  <link rel="index" title="Index" href="../../../genindex/" />
</head>

<body x-data="{ showSidebar: false, showScrollTop: false }"
  class="min-h-screen font-sans antialiased bg-background text-foreground" :class="{ 'overflow-hidden': showSidebar }"@scroll.window="showScrollTop = pageYOffset > 100">
  <div x-cloak x-show="showSidebar"
    class="fixed inset-0 z-50 overflow-hidden bg-background/80 backdrop-blur-sm md:hidden"
    @click.self="showSidebar = false"></div><div id="page" class="relative flex flex-col min-h-screen"><a href="#content"
      class="absolute top-0 left-0 z-[100] block bg-background p-4 text-xl transition -translate-x-full opacity-0 focus:translate-x-0 focus:opacity-100">
      Skip to content
    </a><header class="sticky top-0 z-40 w-full border-b shadow-xs border-border bg-background/90 backdrop-blur"><div class="container flex items-center h-14">
    <div class="hidden mr-4 md:flex">
      <a href="../../../" class="flex items-center mr-6"><span class="hidden font-bold sm:inline-block text-clip whitespace-nowrap">stable-datasets</span>
      </a></div><button
      class="inline-flex items-center justify-center h-10 px-0 py-2 mr-2 text-base font-medium transition-colors rounded-md hover:text-accent-foreground hover:bg-transparent md:hidden"
      type="button" @click="showSidebar = true">
      <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" aria-hidden="true"
        fill="currentColor">
        <path
          d="M152.587 825.087q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440Zm0-203.587q-19.152 0-32.326-13.174T107.087 576q0-19.152 13.174-32.326t32.326-13.174h320q19.152 0 32.326 13.174T518.087 576q0 19.152-13.174 32.326T472.587 621.5h-320Zm0-203.587q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440ZM708.913 576l112.174 112.174q12.674 12.674 12.674 31.826t-12.674 31.826Q808.413 764.5 789.261 764.5t-31.826-12.674l-144-144Q600 594.391 600 576t13.435-31.826l144-144q12.674-12.674 31.826-12.674t31.826 12.674q12.674 12.674 12.674 31.826t-12.674 31.826L708.913 576Z" />
      </svg>
      <span class="sr-only">Toggle navigation menu</span>
    </button>
    <div class="flex items-center justify-between flex-1 gap-2 sm:gap-4 md:justify-end">
      <div class="flex-1 w-full md:w-auto md:flex-none"><form id="searchbox"
      action="../../../search/"
      method="get"
      class="relative flex items-center group"
      @keydown.k.window.meta="$refs.search.focus()">
  <input x-ref="search"
          name="q"
          id="search-input"
          type="search"
          aria-label="Search the docs"
          placeholder="Search ..."
          class="inline-flex items-center font-medium transition-colors bg-transparent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background border border-input hover:bg-accent focus:bg-accent hover:text-accent-foreground focus:text-accent-foreground hover:placeholder-accent-foreground py-2 px-4 relative h-9 w-full justify-start rounded-[0.5rem] text-sm text-muted-foreground sm:pr-12 md:w-40 lg:w-64" />
  <kbd class="pointer-events-none absolute right-1.5 top-2 hidden h-5 select-none text-muted-foreground items-center gap-1 rounded border border-border bg-muted px-1.5 font-mono text-[10px] font-medium opacity-100 sm:flex group-hover:bg-accent group-hover:text-accent-foreground">
    <span class="text-xs">âŒ˜</span>
    K
  </kbd>
</form>
      </div>
      <nav class="flex items-center gap-1">
        <a href="https://github.com/rbalestr-lab/stable-datasets" title="Visit repository on GitHub" rel="noopener nofollow">
          <div
            class="inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md hover:bg-accent hover:text-accent-foreground h-9 w-9">
            <svg height="26px" style="margin-top:-2px;display:inline" viewBox="0 0 45 44" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22.477.927C10.485.927.76 10.65.76 22.647c0 9.596 6.223 17.736 14.853 20.608 1.087.2 1.483-.47 1.483-1.047 0-.516-.019-1.881-.03-3.693-6.04 1.312-7.315-2.912-7.315-2.912-.988-2.51-2.412-3.178-2.412-3.178-1.972-1.346.149-1.32.149-1.32 2.18.154 3.327 2.24 3.327 2.24 1.937 3.318 5.084 2.36 6.321 1.803.197-1.403.759-2.36 1.379-2.903-4.823-.548-9.894-2.412-9.894-10.734 0-2.37.847-4.31 2.236-5.828-.224-.55-.969-2.759.214-5.748 0 0 1.822-.584 5.972 2.226 1.732-.482 3.59-.722 5.437-.732 1.845.01 3.703.25 5.437.732 4.147-2.81 5.967-2.226 5.967-2.226 1.185 2.99.44 5.198.217 5.748 1.392 1.517 2.232 3.457 2.232 5.828 0 8.344-5.078 10.18-9.916 10.717.779.67 1.474 1.996 1.474 4.021 0 2.904-.027 5.247-.027 5.96 0 .58.392 1.256 1.493 1.044C37.981 40.375 44.2 32.24 44.2 22.647c0-11.996-9.726-21.72-21.722-21.72" fill="currentColor"/></svg>
          </div>
        </a>
        
        <button @click="darkMode = !darkMode"
          class="relative inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md hover:bg-accent hover:text-accent-foreground h-9 w-9"
          type="button"
          title="Toggle color scheme">
          <svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 96 960 960" fill="currentColor"
            class="absolute transition-all scale-100 rotate-0 dark:-rotate-90 dark:scale-0">
            <path
              d="M480 685q45.456 0 77.228-31.772Q589 621.456 589 576q0-45.456-31.772-77.228Q525.456 467 480 467q-45.456 0-77.228 31.772Q371 530.544 371 576q0 45.456 31.772 77.228Q434.544 685 480 685Zm0 91q-83 0-141.5-58.5T280 576q0-83 58.5-141.5T480 376q83 0 141.5 58.5T680 576q0 83-58.5 141.5T480 776ZM80 621.5q-19.152 0-32.326-13.174T34.5 576q0-19.152 13.174-32.326T80 530.5h80q19.152 0 32.326 13.174T205.5 576q0 19.152-13.174 32.326T160 621.5H80Zm720 0q-19.152 0-32.326-13.174T754.5 576q0-19.152 13.174-32.326T800 530.5h80q19.152 0 32.326 13.174T925.5 576q0 19.152-13.174 32.326T880 621.5h-80Zm-320-320q-19.152 0-32.326-13.174T434.5 256v-80q0-19.152 13.174-32.326T480 130.5q19.152 0 32.326 13.174T525.5 176v80q0 19.152-13.174 32.326T480 301.5Zm0 720q-19.152 0-32.326-13.17Q434.5 995.152 434.5 976v-80q0-19.152 13.174-32.326T480 850.5q19.152 0 32.326 13.174T525.5 896v80q0 19.152-13.174 32.33-13.174 13.17-32.326 13.17ZM222.174 382.065l-43-42Q165.5 327.391 166 308.239t13.174-33.065q13.435-13.674 32.587-13.674t32.065 13.674l42.239 43q12.674 13.435 12.555 31.706-.12 18.272-12.555 31.946-12.674 13.674-31.445 13.413-18.772-.261-32.446-13.174Zm494 494.761-42.239-43q-12.674-13.435-12.674-32.087t12.674-31.565Q686.609 756.5 705.38 757q18.772.5 32.446 13.174l43 41.761Q794.5 824.609 794 843.761t-13.174 33.065Q767.391 890.5 748.239 890.5t-32.065-13.674Zm-42-494.761Q660.5 369.391 661 350.62q.5-18.772 13.174-32.446l41.761-43Q728.609 261.5 747.761 262t33.065 13.174q13.674 13.435 13.674 32.587t-13.674 32.065l-43 42.239q-13.435 12.674-31.706 12.555-18.272-.12-31.946-12.555Zm-495 494.761Q165.5 863.391 165.5 844.239t13.674-32.065l43-42.239q13.435-12.674 32.087-12.674t31.565 12.674Q299.5 782.609 299 801.38q-.5 18.772-13.174 32.446l-41.761 43Q231.391 890.5 212.239 890t-33.065-13.174ZM480 576Z" />
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 96 960 960" fill="currentColor"
            class="absolute transition-all scale-0 rotate-90 dark:rotate-0 dark:scale-100">
            <path
              d="M480 936q-151 0-255.5-104.5T120 576q0-138 90-239.5T440 218q25-3 39 18t-1 44q-17 26-25.5 55t-8.5 61q0 90 63 153t153 63q31 0 61.5-9t54.5-25q21-14 43-1.5t19 39.5q-14 138-117.5 229T480 936Zm0-80q88 0 158-48.5T740 681q-20 5-40 8t-40 3q-123 0-209.5-86.5T364 396q0-20 3-40t8-40q-78 32-126.5 102T200 576q0 116 82 198t198 82Zm-10-270Z" />
          </svg>
        </button>
      </nav>
    </div>
  </div>
</header>

    <div class="flex-1"><div
        class="container md:grid md:grid-cols-[220px_minmax(0,1fr)] md:gap-6 lg:grid-cols-[240px_minmax(0,1fr)] lg:gap-10"><aside id="left-sidebar"
  class="fixed inset-y-0 left-0 md:top-14 z-50 md:z-30 bg-background md:bg-transparent transition-all duration-100 -translate-x-full md:translate-x-0 ml-0 p-6 md:p-0 md:-ml-2 md:h-[calc(100vh-3.5rem)] w-5/6 md:w-full overflow-y-auto border-r border-border md:sticky"
  :aria-hidden="!showSidebar" :class="{ 'translate-x-0': showSidebar }">

    <a href="../../../" class="justify-start text-sm md:!hidden bg-background"><span class="font-bold text-clip whitespace-nowrap">stable-datasets</span>
    </a>

    <div class="relative overflow-hidden md:overflow-auto my-4 md:my-0">
      <div class="overflow-y-auto h-full w-full relative pr-6"><nav class="table w-full min-w-full my-6 lg:my-8">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../datasets/">Datasets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/arabic_characters/">Arabic Characters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/arabic_digits/">Arabic Digits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/cifar10/">CIFAR-10</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/cifar100/">CIFAR-100</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/cifar10_c/">CIFAR-10-C</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/cifar100_c/">CIFAR-100-C</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/cars196/">CARS-196</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/dtd/">Describable Textures Dataset (DTD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/fashion_mnist/">Fashion-MNIST</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/k_mnist/">Kuzushiji-MNIST</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/medmnist/">MedMNIST</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/stl10/">STL-10</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/e_mnist/">EMNIST</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/flowers102/">Flowers102</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/cub200/">CUB-200</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/country211/">Country-211</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/hasy_v2/">HASYv2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/face_pointing/">Face Pointing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/rock_paper_scissor/">Rock Paper Scissor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/linnaeus5/">Linnaeus 5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../datasets/cc3m/">CC3M (Conceptual Captions)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/quickstart/">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/showcase/">Showcase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/contributing/">Contributing</a></li>
</ul>

</nav>
      </div>
    </div>
    <button type="button" @click="showSidebar = false"
      class="absolute md:hidden right-4 top-4 rounded-sm opacity-70 transition-opacity hover:opacity-100">
      <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" fill="currentColor"
        stroke="none" class="h-4 w-4">
        <path
          d="M480 632 284 828q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536 576l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480 632Z" />
      </svg>
    </button>
  </aside>
          <main class="relative py-6 lg:gap-10 lg:py-8 xl:grid xl:grid-cols-[1fr_300px]">
<div class="w-full min-w-0 mx-auto">
<nav aria-label="breadcrumbs"
     class="flex items-center mb-4 space-x-1 text-sm text-muted-foreground">
  <a class="overflow-hidden text-ellipsis whitespace-nowrap hover:text-foreground"
     href="../../../">
    <span class="hidden md:inline">stable-datasets</span>
    <svg xmlns="http://www.w3.org/2000/svg"
         height="18"
         width="18"
         viewBox="0 96 960 960"
         aria-label="Home"
         fill="currentColor"
         stroke="none"
         class="md:hidden">
      <path d="M240 856h120V616h240v240h120V496L480 316 240 496v360Zm-80 80V456l320-240 320 240v480H520V696h-80v240H160Zm320-350Z" />
    </svg>
  </a>
  
<div class="mr-1">/</div><a class="hover:text-foreground overflow-hidden text-ellipsis whitespace-nowrap"
       href="../../">Module code</a>
    
<div class="mr-1">/</div><span aria-current="page"
        class="font-medium text-foreground overflow-hidden text-ellipsis whitespace-nowrap">stable_datasets.utils</span>
</nav>

    <div id="content" role="main">
      <h1>Source code for stable_datasets.utils</h1><div class="highlight"><pre>
<span></span><code><span id="line-1"><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</span><span id="line-2"><span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
</span><span id="line-3"><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="line-4"><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="line-5"><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Mapping</span>
</span><span id="line-6"><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
</span><span id="line-7"><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="line-8"><span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">MappingProxyType</span>
</span><span id="line-9"><span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
</span><span id="line-10">
</span><span id="line-11"><span class="kn">import</span><span class="w"> </span><span class="nn">datasets</span>
</span><span id="line-12"><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="line-13"><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="line-14"><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
</span><span id="line-15"><span class="kn">import</span><span class="w"> </span><span class="nn">rich.progress</span>
</span><span id="line-16"><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">DownloadConfig</span>
</span><span id="line-17"><span class="kn">from</span><span class="w"> </span><span class="nn">filelock</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileLock</span>
</span><span id="line-18"><span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">logging</span>
</span><span id="line-19"><span class="kn">from</span><span class="w"> </span><span class="nn">rich.progress</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="line-20">    <span class="n">BarColumn</span><span class="p">,</span>
</span><span id="line-21">    <span class="n">MofNCompleteColumn</span><span class="p">,</span>
</span><span id="line-22">    <span class="n">TextColumn</span><span class="p">,</span>
</span><span id="line-23">    <span class="n">TimeElapsedColumn</span><span class="p">,</span>
</span><span id="line-24">    <span class="n">TimeRemainingColumn</span><span class="p">,</span>
</span><span id="line-25"><span class="p">)</span>
</span><span id="line-26"><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="line-27">
</span><span id="line-28">
</span><span id="line-29"><span class="n">DEFAULT_CACHE_DIR</span> <span class="o">=</span> <span class="s2">&quot;~/.stable_datasets/&quot;</span>
</span><span id="line-30">
</span><span id="line-31">
</span><span id="line-32"><span class="k">def</span><span class="w"> </span><span class="nf">_default_dest_folder</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="line-33"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Default folder where files are saved.&quot;&quot;&quot;</span>
</span><span id="line-34">    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">DEFAULT_CACHE_DIR</span><span class="p">))</span> <span class="o">/</span> <span class="s2">&quot;downloads&quot;</span>
</span><span id="line-35">
</span><span id="line-36">
</span><span id="line-37"><span class="k">def</span><span class="w"> </span><span class="nf">_default_processed_cache_dir</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="line-38"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Default folder where processed datasets (Arrow files) are cached.&quot;&quot;&quot;</span>
</span><span id="line-39">    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">DEFAULT_CACHE_DIR</span><span class="p">))</span> <span class="o">/</span> <span class="s2">&quot;processed&quot;</span>
</span><span id="line-40">
</span><span id="line-41">
<div class="viewcode-block" id="BaseDatasetBuilder">
<a class="viewcode-back" href="../../../stable_datasets/#stable_datasets.utils.BaseDatasetBuilder">[docs]</a>
</span><span id="line-42"><span class="k">class</span><span class="w"> </span><span class="nc">BaseDatasetBuilder</span><span class="p">(</span><span class="n">datasets</span><span class="o">.</span><span class="n">GeneratorBasedBuilder</span><span class="p">):</span>
</span><span id="line-43"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-44"><span class="sd">    Base class for stable-datasets that enables direct dataset loading.</span>
</span><span id="line-45"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-46">
</span><span id="line-47">    <span class="c1"># Subclasses must define:</span>
</span><span id="line-48">    <span class="c1"># - VERSION: datasets.Version</span>
</span><span id="line-49">    <span class="c1">#</span>
</span><span id="line-50">    <span class="c1"># For dataset provenance / downloads, subclasses can either:</span>
</span><span id="line-51">    <span class="c1"># - define a class attribute SOURCE (static), or</span>
</span><span id="line-52">    <span class="c1"># - override _source(self) to compute it at runtime (e.g. from self.config)</span>
</span><span id="line-53">    <span class="n">VERSION</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">Version</span>
</span><span id="line-54">    <span class="n">SOURCE</span><span class="p">:</span> <span class="n">Mapping</span>
</span><span id="line-55">
</span><span id="line-56">    <span class="nd">@staticmethod</span>
</span><span id="line-57">    <span class="k">def</span><span class="w"> </span><span class="nf">_freeze</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="line-58"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-59"><span class="sd">        Recursively freeze basic Python containers to make SOURCE effectively immutable.</span>
</span><span id="line-60">
</span><span id="line-61"><span class="sd">        - dict / Mapping -&gt; MappingProxyType(dict(...)) (shallowly immutable mapping)</span>
</span><span id="line-62"><span class="sd">        - list / tuple -&gt; tuple(...)</span>
</span><span id="line-63"><span class="sd">        - set -&gt; frozenset(...)</span>
</span><span id="line-64"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-65">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">MappingProxyType</span><span class="p">):</span>
</span><span id="line-66">            <span class="k">return</span> <span class="n">obj</span>
</span><span id="line-67">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
</span><span id="line-68">            <span class="c1"># Create a fresh dict so callers can&#39;t retain a handle to the mutable original.</span>
</span><span id="line-69">            <span class="k">return</span> <span class="n">MappingProxyType</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">BaseDatasetBuilder</span><span class="o">.</span><span class="n">_freeze</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</span><span id="line-70">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="line-71">            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">BaseDatasetBuilder</span><span class="o">.</span><span class="n">_freeze</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="line-72">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
</span><span id="line-73">            <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">BaseDatasetBuilder</span><span class="o">.</span><span class="n">_freeze</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="line-74">        <span class="k">return</span> <span class="n">obj</span>
</span><span id="line-75">
</span><span id="line-76">    <span class="k">def</span><span class="w"> </span><span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-77">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-78">
</span><span id="line-79">        <span class="c1"># Don&#39;t validate the base class itself</span>
</span><span id="line-80">        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">BaseDatasetBuilder</span><span class="p">:</span>
</span><span id="line-81">            <span class="k">return</span>
</span><span id="line-82">
</span><span id="line-83">        <span class="c1"># Allow tests / internal helpers to opt out if needed</span>
</span><span id="line-84">        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_SKIP_SOURCE_VALIDATION&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="line-85">            <span class="k">return</span>
</span><span id="line-86">
</span><span id="line-87">        <span class="c1"># VERSION must exist and be a datasets.Version</span>
</span><span id="line-88">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;VERSION&quot;</span><span class="p">):</span>
</span><span id="line-89">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> must define a class attribute VERSION = datasets.Version(&#39;x.y.z&#39;).&quot;</span><span class="p">)</span>
</span><span id="line-90">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;VERSION&quot;</span><span class="p">),</span> <span class="n">datasets</span><span class="o">.</span><span class="n">Version</span><span class="p">):</span>
</span><span id="line-91">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.VERSION must be a datasets.Version instance.&quot;</span><span class="p">)</span>
</span><span id="line-92">
</span><span id="line-93">        <span class="c1"># Enforce that a source is provided either statically (SOURCE) or dynamically (_source override).</span>
</span><span id="line-94">        <span class="n">has_static_source</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;SOURCE&quot;</span><span class="p">)</span>
</span><span id="line-95">        <span class="n">has_dynamic_source</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">BaseDatasetBuilder</span><span class="o">.</span><span class="n">_source</span>  <span class="c1"># overridden</span>
</span><span id="line-96">        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">has_static_source</span> <span class="ow">or</span> <span class="n">has_dynamic_source</span><span class="p">):</span>
</span><span id="line-97">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="line-98">                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> must define SOURCE = </span><span class="se">{{</span><span class="s2">...</span><span class="se">}}</span><span class="s2"> or override _source(self) to compute it at runtime.&quot;</span>
</span><span id="line-99">            <span class="p">)</span>
</span><span id="line-100">
</span><span id="line-101">        <span class="c1"># Freeze static SOURCE at class creation time.</span>
</span><span id="line-102">        <span class="k">if</span> <span class="n">has_static_source</span><span class="p">:</span>
</span><span id="line-103">            <span class="bp">cls</span><span class="o">.</span><span class="n">SOURCE</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_freeze</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;SOURCE&quot;</span><span class="p">))</span>
</span><span id="line-104">
</span><span id="line-105">        <span class="c1"># If subclass overrides _source(), wrap it so the returned mapping is frozen/immutable.</span>
</span><span id="line-106">        <span class="k">if</span> <span class="n">has_dynamic_source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_source</span><span class="p">,</span> <span class="s2">&quot;_stable_datasets_freezes_source&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="line-107">            <span class="n">original</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_source</span>
</span><span id="line-108">
</span><span id="line-109">            <span class="k">def</span><span class="w"> </span><span class="nf">_wrapped_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-110">                <span class="n">source</span> <span class="o">=</span> <span class="n">original</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="line-111">                <span class="k">return</span> <span class="n">BaseDatasetBuilder</span><span class="o">.</span><span class="n">_freeze</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="line-112">
</span><span id="line-113">            <span class="n">_wrapped_source</span><span class="o">.</span><span class="n">_stable_datasets_freezes_source</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[attr-defined]</span>
</span><span id="line-114">            <span class="bp">cls</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">_wrapped_source</span>  <span class="c1"># type: ignore[method-assign]</span>
</span><span id="line-115">
</span><span id="line-116">    <span class="k">def</span><span class="w"> </span><span class="nf">_source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
</span><span id="line-117"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-118"><span class="sd">        Return dataset provenance / download configuration.</span>
</span><span id="line-119">
</span><span id="line-120"><span class="sd">        Default: uses a class attribute SOURCE (frozen into an immutable Mapping).</span>
</span><span id="line-121"><span class="sd">        Override in subclasses when the source depends on runtime config (e.g. self.config.variant).</span>
</span><span id="line-122"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-123">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s2">&quot;SOURCE&quot;</span><span class="p">):</span>
</span><span id="line-124">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> does not define SOURCE and did not override _source().&quot;</span><span class="p">)</span>
</span><span id="line-125">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s2">&quot;SOURCE&quot;</span><span class="p">)</span>
</span><span id="line-126">
</span><span id="line-127">    <span class="nd">@staticmethod</span>
</span><span id="line-128">    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_source</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-129">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
</span><span id="line-130">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;source must be a mapping.&quot;</span><span class="p">)</span>
</span><span id="line-131">
</span><span id="line-132">        <span class="c1"># Required for provenance</span>
</span><span id="line-133">        <span class="k">if</span> <span class="s2">&quot;homepage&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span> <span class="ow">or</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;homepage&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;homepage&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-134">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;SOURCE[&#39;homepage&#39;] must be a string and must be present.&quot;</span><span class="p">)</span>
</span><span id="line-135">        <span class="k">if</span> <span class="s2">&quot;citation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span> <span class="ow">or</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;citation&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;citation&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-136">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;SOURCE[&#39;citation&#39;] must be a string and must be present.&quot;</span><span class="p">)</span>
</span><span id="line-137">
</span><span id="line-138">        <span class="c1"># Required for downloads (even if a dataset overrides _split_generators).</span>
</span><span id="line-139">        <span class="k">if</span> <span class="s2">&quot;assets&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;assets&quot;</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">):</span>
</span><span id="line-140">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;SOURCE must contain a mapping-valued &#39;assets&#39; key.&quot;</span><span class="p">)</span>
</span><span id="line-141">
</span><span id="line-142">    <span class="k">def</span><span class="w"> </span><span class="nf">_split_generators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dl_manager</span><span class="p">):</span>
</span><span id="line-143"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-144"><span class="sd">        Default split generator implementation.</span>
</span><span id="line-145">
</span><span id="line-146"><span class="sd">        Most stable-datasets follow the pattern &quot;one downloadable file per split&quot;, expressed</span>
</span><span id="line-147"><span class="sd">        via `SOURCE[&quot;assets&quot;]`. Datasets with different layouts can override this method.</span>
</span><span id="line-148"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-149">        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">()</span>
</span><span id="line-150">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
</span><span id="line-151">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">._source() must return a mapping.&quot;</span><span class="p">)</span>
</span><span id="line-152">        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="line-153">
</span><span id="line-154">        <span class="n">assets</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;assets&quot;</span><span class="p">]</span>
</span><span id="line-155">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">assets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-156">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.SOURCE[&#39;assets&#39;] is empty; cannot infer splits.&quot;</span><span class="p">)</span>
</span><span id="line-157">
</span><span id="line-158">        <span class="n">split_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="line-159">        <span class="n">ordered_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">assets</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">split_names</span><span class="p">]</span>
</span><span id="line-160">
</span><span id="line-161">        <span class="c1"># stable-datasets standardizes on our local bulk downloader (not HF dl_manager).</span>
</span><span id="line-162">        <span class="c1"># Deduplicate URLs to avoid redundant downloads for datasets where all splits share a single file.</span>
</span><span id="line-163">        <span class="n">unique_urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">ordered_urls</span><span class="p">))</span>
</span><span id="line-164">        <span class="n">download_dir</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_raw_download_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="line-165">        <span class="k">if</span> <span class="n">download_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-166">            <span class="n">download_dir</span> <span class="o">=</span> <span class="n">_default_dest_folder</span><span class="p">()</span>
</span><span id="line-167">        <span class="n">unique_paths</span> <span class="o">=</span> <span class="n">bulk_download</span><span class="p">(</span><span class="n">unique_urls</span><span class="p">,</span> <span class="n">dest_folder</span><span class="o">=</span><span class="n">download_dir</span><span class="p">)</span>
</span><span id="line-168">        <span class="n">url_to_path</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_urls</span><span class="p">,</span> <span class="n">unique_paths</span><span class="p">))</span>
</span><span id="line-169">        <span class="n">local_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">url_to_path</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">ordered_urls</span><span class="p">]</span>
</span><span id="line-170">
</span><span id="line-171">        <span class="n">split_to_path</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">split_names</span><span class="p">,</span> <span class="n">local_paths</span><span class="p">))</span>
</span><span id="line-172">
</span><span id="line-173">        <span class="n">name_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="line-174">            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">Split</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">,</span>
</span><span id="line-175">            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">Split</span><span class="o">.</span><span class="n">TEST</span><span class="p">,</span>
</span><span id="line-176">            <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">Split</span><span class="o">.</span><span class="n">VALIDATION</span><span class="p">,</span>
</span><span id="line-177">        <span class="p">}</span>
</span><span id="line-178">
</span><span id="line-179">        <span class="k">return</span> <span class="p">[</span>
</span><span id="line-180">            <span class="n">datasets</span><span class="o">.</span><span class="n">SplitGenerator</span><span class="p">(</span>
</span><span id="line-181">                <span class="n">name</span><span class="o">=</span><span class="n">name_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">split_name</span><span class="p">,</span> <span class="n">split_name</span><span class="p">),</span>
</span><span id="line-182">                <span class="n">gen_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="n">split_to_path</span><span class="p">[</span><span class="n">split_name</span><span class="p">],</span> <span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="n">split_name</span><span class="p">},</span>
</span><span id="line-183">            <span class="p">)</span>
</span><span id="line-184">            <span class="k">for</span> <span class="n">split_name</span> <span class="ow">in</span> <span class="n">split_names</span>
</span><span id="line-185">        <span class="p">]</span>
</span><span id="line-186">
</span><span id="line-187">    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">processed_cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-188"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-189"><span class="sd">        Automatically download, prepare, and return the dataset for the specified split.</span>
</span><span id="line-190">
</span><span id="line-191"><span class="sd">        Args:</span>
</span><span id="line-192"><span class="sd">            split: Dataset split to load (e.g., &quot;train&quot;, &quot;test&quot;, &quot;validation&quot;). If None,</span>
</span><span id="line-193"><span class="sd">                loads all available splits and returns a DatasetDict.</span>
</span><span id="line-194"><span class="sd">            processed_cache_dir: Cache directory for processed datasets (Arrow cache). If None,</span>
</span><span id="line-195"><span class="sd">                defaults to ~/.stable_datasets/processed/.</span>
</span><span id="line-196"><span class="sd">            download_dir: Directory for raw downloads (ZIP/NPZ/etc). If None, defaults to</span>
</span><span id="line-197"><span class="sd">                ~/.stable_datasets/downloads/.</span>
</span><span id="line-198"><span class="sd">            **kwargs: Additional arguments passed to the dataset builder.</span>
</span><span id="line-199">
</span><span id="line-200"><span class="sd">        Returns:</span>
</span><span id="line-201"><span class="sd">            Union[datasets.Dataset, datasets.DatasetDict]: The loaded dataset (single split)</span>
</span><span id="line-202"><span class="sd">                or a DatasetDict (all splits).</span>
</span><span id="line-203"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-204">        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="line-205">
</span><span id="line-206">        <span class="c1"># 1) Decide cache locations</span>
</span><span id="line-207">        <span class="c1"># Processed cache (Arrow)</span>
</span><span id="line-208">        <span class="k">if</span> <span class="n">processed_cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-209">            <span class="n">processed_cache_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_default_processed_cache_dir</span><span class="p">())</span>
</span><span id="line-210">        <span class="n">instance</span><span class="o">.</span><span class="n">_processed_cache_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">processed_cache_dir</span><span class="p">)</span>
</span><span id="line-211">
</span><span id="line-212">        <span class="c1"># Raw downloads</span>
</span><span id="line-213">        <span class="k">if</span> <span class="n">download_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-214">            <span class="n">download_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_default_dest_folder</span><span class="p">())</span>
</span><span id="line-215">        <span class="n">instance</span><span class="o">.</span><span class="n">_raw_download_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
</span><span id="line-216">
</span><span id="line-217">        <span class="c1"># 2) Initialize builder with our processed cache_dir explicitly</span>
</span><span id="line-218">        <span class="n">instance</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">processed_cache_dir</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-219">
</span><span id="line-220">        <span class="c1"># 2b) Validate dataset SOURCE contract early.</span>
</span><span id="line-221">        <span class="n">source</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_source</span><span class="p">()</span>
</span><span id="line-222">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
</span><span id="line-223">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">._source() must return a mapping.&quot;</span><span class="p">)</span>
</span><span id="line-224">        <span class="bp">cls</span><span class="o">.</span><span class="n">_validate_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="line-225">
</span><span id="line-226">        <span class="c1"># 3) Explicitly tell HF to use our processed cache_dir for any dl_manager downloads</span>
</span><span id="line-227">        <span class="n">download_config</span> <span class="o">=</span> <span class="n">DownloadConfig</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">processed_cache_dir</span><span class="p">))</span>
</span><span id="line-228">
</span><span id="line-229">        <span class="n">instance</span><span class="o">.</span><span class="n">download_and_prepare</span><span class="p">(</span>
</span><span id="line-230">            <span class="n">download_config</span><span class="o">=</span><span class="n">download_config</span><span class="p">,</span>
</span><span id="line-231">        <span class="p">)</span>
</span><span id="line-232">
</span><span id="line-233">        <span class="c1"># 4) Load the split from the same cache_dir</span>
</span><span id="line-234">        <span class="k">if</span> <span class="n">split</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-235">            <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">as_dataset</span><span class="p">()</span>
</span><span id="line-236">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-237">            <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">as_dataset</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">)</span>
</span><span id="line-238">
</span><span id="line-239">        <span class="c1"># Expose cache locations on the returned dataset object for convenience.</span>
</span><span id="line-240">        <span class="c1"># Note: DatasetDict may not allow attribute assignment; ignore if not supported.</span>
</span><span id="line-241">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-242">            <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;_stable_datasets_processed_cache_dir&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">_processed_cache_dir</span><span class="p">)</span>
</span><span id="line-243">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="line-244">            <span class="k">pass</span>
</span><span id="line-245">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-246">            <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;_stable_datasets_download_dir&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">_raw_download_dir</span><span class="p">)</span>
</span><span id="line-247">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="line-248">            <span class="k">pass</span>
</span><span id="line-249">        <span class="k">return</span> <span class="n">result</span></div>

</span><span id="line-250">
</span><span id="line-251">
<div class="viewcode-block" id="bulk_download">
<a class="viewcode-back" href="../../../stable_datasets/#stable_datasets.utils.bulk_download">[docs]</a>
</span><span id="line-252"><span class="k">def</span><span class="w"> </span><span class="nf">bulk_download</span><span class="p">(</span>
</span><span id="line-253">    <span class="n">urls</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="line-254">    <span class="n">dest_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
</span><span id="line-255"><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
</span><span id="line-256"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-257"><span class="sd">    Download multiple files concurrently and return their local paths.</span>
</span><span id="line-258">
</span><span id="line-259"><span class="sd">    Args:</span>
</span><span id="line-260"><span class="sd">        urls: Iterable of URL strings to download.</span>
</span><span id="line-261"><span class="sd">        dest_folder: Destination folder for downloads.</span>
</span><span id="line-262">
</span><span id="line-263"><span class="sd">    Returns:</span>
</span><span id="line-264"><span class="sd">        list[Path]: Local file paths in the same order as the input URLs.</span>
</span><span id="line-265"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-266">    <span class="n">urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span>
</span><span id="line-267">    <span class="n">num_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">urls</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="line-268">    <span class="k">if</span> <span class="n">num_workers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-269">        <span class="k">return</span> <span class="p">[]</span>
</span><span id="line-270">
</span><span id="line-271">    <span class="n">dest_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">)</span>
</span><span id="line-272">    <span class="n">dest_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-273">
</span><span id="line-274">    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">]</span>
</span><span id="line-275">    <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span>
</span><span id="line-276">
</span><span id="line-277">    <span class="k">with</span> <span class="n">rich</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span>
</span><span id="line-278">        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span id="line-279">        <span class="n">BarColumn</span><span class="p">(),</span>
</span><span id="line-280">        <span class="n">MofNCompleteColumn</span><span class="p">(),</span>
</span><span id="line-281">        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;â€¢&quot;</span><span class="p">),</span>
</span><span id="line-282">        <span class="n">TimeElapsedColumn</span><span class="p">(),</span>
</span><span id="line-283">        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;â€¢&quot;</span><span class="p">),</span>
</span><span id="line-284">        <span class="n">TimeRemainingColumn</span><span class="p">(),</span>
</span><span id="line-285">        <span class="n">refresh_per_second</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="line-286">    <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
</span><span id="line-287">        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-288">        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
</span><span id="line-289">            <span class="n">_progress</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>  <span class="c1"># shared between worker processes</span>
</span><span id="line-290">
</span><span id="line-291">            <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span><span id="line-292">                <span class="c1"># submit one download task per URL</span>
</span><span id="line-293">                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">urls</span><span class="p">)):</span>
</span><span id="line-294">                    <span class="n">task_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="line-295">                    <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span><span id="line-296">                        <span class="n">download</span><span class="p">,</span>
</span><span id="line-297">                        <span class="n">urls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="line-298">                        <span class="n">dest_folder</span><span class="p">,</span>
</span><span id="line-299">                        <span class="kc">False</span><span class="p">,</span>  <span class="c1"># disable per-file tqdm; Rich handles progress</span>
</span><span id="line-300">                        <span class="kc">False</span><span class="p">,</span>
</span><span id="line-301">                        <span class="n">_progress</span><span class="p">,</span>
</span><span id="line-302">                        <span class="n">task_id</span><span class="p">,</span>
</span><span id="line-303">                    <span class="p">)</span>
</span><span id="line-304">                    <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">future</span><span class="p">))</span>
</span><span id="line-305">
</span><span id="line-306">                <span class="n">rich_tasks</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-307">
</span><span id="line-308">                <span class="c1"># update Rich progress while downloads are running</span>
</span><span id="line-309">                <span class="k">while</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">):</span>
</span><span id="line-310">                    <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">prog</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">_progress</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="line-311">                        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rich_tasks</span><span class="p">:</span>
</span><span id="line-312">                            <span class="n">rich_tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
</span><span id="line-313">                                <span class="sa">f</span><span class="s2">&quot;[green]</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="line-314">                                <span class="n">total</span><span class="o">=</span><span class="n">prog</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">],</span>
</span><span id="line-315">                                <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="line-316">                            <span class="p">)</span>
</span><span id="line-317">                        <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="line-318">                            <span class="n">rich_tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">],</span>
</span><span id="line-319">                            <span class="n">completed</span><span class="o">=</span><span class="n">prog</span><span class="p">[</span><span class="s2">&quot;progress&quot;</span><span class="p">],</span>
</span><span id="line-320">                        <span class="p">)</span>
</span><span id="line-321">                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="line-322">
</span><span id="line-323">            <span class="c1"># collect results in the same order as urls</span>
</span><span id="line-324">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
</span><span id="line-325">                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span><span id="line-326">
</span><span id="line-327">    <span class="k">return</span> <span class="n">results</span></div>

</span><span id="line-328">
</span><span id="line-329">
<div class="viewcode-block" id="download">
<a class="viewcode-back" href="../../../stable_datasets/#stable_datasets.utils.download">[docs]</a>
</span><span id="line-330"><span class="k">def</span><span class="w"> </span><span class="nf">download</span><span class="p">(</span>
</span><span id="line-331">    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="line-332">    <span class="n">dest_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="line-333">    <span class="n">progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="line-334">    <span class="n">_progress_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="line-335">    <span class="n">_task_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="line-336"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="line-337">    <span class="k">if</span> <span class="n">dest_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-338">        <span class="n">dest_folder</span> <span class="o">=</span> <span class="n">_default_dest_folder</span><span class="p">()</span>
</span><span id="line-339">    <span class="n">dest_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">)</span>
</span><span id="line-340">    <span class="n">dest_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-341">
</span><span id="line-342">    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span><span id="line-343">    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="line-344">    <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
</span><span id="line-345">    <span class="c1"># Keep original extension at the end: e.g. cars196_test.0275d128da.zip</span>
</span><span id="line-346">    <span class="n">dest</span> <span class="o">=</span> <span class="n">dest_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">h</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="line-347">    <span class="n">lock</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">dest</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span><span class="p">)</span>
</span><span id="line-348">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">dest</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">)</span>
</span><span id="line-349">
</span><span id="line-350">    <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">lock</span><span class="p">):</span>
</span><span id="line-351">        <span class="c1"># If you trust your pipeline never leaves a partial &#39;dest&#39;, this is OK.</span>
</span><span id="line-352">        <span class="c1"># Otherwise, prefer a size/checksum validation here.</span>
</span><span id="line-353">        <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="line-354">            <span class="k">return</span> <span class="n">dest</span>
</span><span id="line-355">
</span><span id="line-356">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-357">            <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="line-358">                <span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="line-359">                    <span class="p">{</span>
</span><span id="line-360">                        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="line-361">                            <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) &quot;</span>
</span><span id="line-362">                            <span class="s2">&quot;AppleWebKit/537.36 (KHTML, like Gecko) &quot;</span>
</span><span id="line-363">                            <span class="s2">&quot;Chrome/91.0.4472.124 Safari/537.36&quot;</span>
</span><span id="line-364">                        <span class="p">)</span>
</span><span id="line-365">                    <span class="p">}</span>
</span><span id="line-366">                <span class="p">)</span>
</span><span id="line-367">                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-368">
</span><span id="line-369">                <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="line-370">                    <span class="n">url</span><span class="p">,</span>
</span><span id="line-371">                    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="line-372">                    <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="line-373">                    <span class="n">timeout</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>  <span class="c1"># you can tune this</span>
</span><span id="line-374">                <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="line-375">                    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="line-376">
</span><span id="line-377">                    <span class="n">total_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="line-378">                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total size: </span><span class="si">{</span><span class="n">total_size</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
</span><span id="line-379">
</span><span id="line-380">                    <span class="n">downloaded</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-381">                    <span class="k">with</span> <span class="p">(</span>
</span><span id="line-382">                        <span class="nb">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span>
</span><span id="line-383">                        <span class="n">tqdm</span><span class="p">(</span>
</span><span id="line-384">                            <span class="n">desc</span><span class="o">=</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="line-385">                            <span class="n">total</span><span class="o">=</span><span class="n">total_size</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="line-386">                            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span>
</span><span id="line-387">                            <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="line-388">                            <span class="n">unit_divisor</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
</span><span id="line-389">                            <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress_bar</span><span class="p">,</span>
</span><span id="line-390">                        <span class="p">)</span> <span class="k">as</span> <span class="n">bar</span><span class="p">,</span>
</span><span id="line-391">                    <span class="p">):</span>
</span><span id="line-392">                        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
</span><span id="line-393">                            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
</span><span id="line-394">                                <span class="k">continue</span>
</span><span id="line-395">                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</span><span id="line-396">                            <span class="n">downloaded</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</span><span id="line-397">                            <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
</span><span id="line-398">
</span><span id="line-399">                            <span class="k">if</span> <span class="n">_progress_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_task_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-400">                                <span class="n">_progress_dict</span><span class="p">[</span><span class="n">_task_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="line-401">                                    <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="n">downloaded</span><span class="p">,</span>
</span><span id="line-402">                                    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total_size</span><span class="p">,</span>
</span><span id="line-403">                                <span class="p">}</span>
</span><span id="line-404">
</span><span id="line-405">            <span class="c1"># Validate *on disk*</span>
</span><span id="line-406">            <span class="k">if</span> <span class="n">total_size</span> <span class="ow">and</span> <span class="n">tmp</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">!=</span> <span class="n">total_size</span><span class="p">:</span>
</span><span id="line-407">                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download incomplete for </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: got </span><span class="si">{</span><span class="n">tmp</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">total_size</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
</span><span id="line-408">
</span><span id="line-409">            <span class="n">tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>  <span class="c1"># atomic rename</span>
</span><span id="line-410">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download finished: </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-411">            <span class="k">return</span> <span class="n">dest</span>
</span><span id="line-412">
</span><span id="line-413">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="line-414">            <span class="c1"># Clean up temp file on failure</span>
</span><span id="line-415">            <span class="k">try</span><span class="p">:</span>
</span><span id="line-416">                <span class="k">if</span> <span class="n">tmp</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="line-417">                    <span class="n">tmp</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span><span id="line-418">            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="line-419">                <span class="k">pass</span>
</span><span id="line-420">            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-421">            <span class="k">raise</span>
</span><span id="line-422">        <span class="k">finally</span><span class="p">:</span>
</span><span id="line-423">            <span class="c1"># Remove lock file so download dir stays clean (FileLock may leave it on some platforms / crash)</span>
</span><span id="line-424">            <span class="k">try</span><span class="p">:</span>
</span><span id="line-425">                <span class="k">if</span> <span class="n">lock</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="line-426">                    <span class="n">lock</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span><span id="line-427">            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="line-428">                <span class="k">pass</span></div>

</span><span id="line-429">
</span><span id="line-430">
<div class="viewcode-block" id="load_from_tsfile_to_dataframe">
<a class="viewcode-back" href="../../../stable_datasets/#stable_datasets.utils.load_from_tsfile_to_dataframe">[docs]</a>
</span><span id="line-431"><span class="k">def</span><span class="w"> </span><span class="nf">load_from_tsfile_to_dataframe</span><span class="p">(</span>
</span><span id="line-432">    <span class="n">full_file_path_and_name</span><span class="p">,</span>
</span><span id="line-433">    <span class="n">return_separate_X_and_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="line-434">    <span class="n">replace_missing_vals_with</span><span class="o">=</span><span class="s2">&quot;NaN&quot;</span><span class="p">,</span>
</span><span id="line-435"><span class="p">):</span>
</span><span id="line-436"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load data from a .ts file into a Pandas DataFrame.</span>
</span><span id="line-437"><span class="sd">    Credit to https://github.com/sktime/sktime/blob/7d572796ec519c35d30f482f2020c3e0256dd451/sktime/datasets/_data_io.py#L379</span>
</span><span id="line-438"><span class="sd">    Parameters</span>
</span><span id="line-439"><span class="sd">    ----------</span>
</span><span id="line-440"><span class="sd">    full_file_path_and_name: str</span>
</span><span id="line-441"><span class="sd">        The full pathname of the .ts file to read.</span>
</span><span id="line-442"><span class="sd">    return_separate_X_and_y: bool</span>
</span><span id="line-443"><span class="sd">        true if X and Y values should be returned as separate Data Frames (</span>
</span><span id="line-444"><span class="sd">        X) and a numpy array (y), false otherwise.</span>
</span><span id="line-445"><span class="sd">        This is only relevant for data that</span>
</span><span id="line-446"><span class="sd">    replace_missing_vals_with: str</span>
</span><span id="line-447"><span class="sd">       The value that missing values in the text file should be replaced</span>
</span><span id="line-448"><span class="sd">       with prior to parsing.</span>
</span><span id="line-449"><span class="sd">    Returns</span>
</span><span id="line-450"><span class="sd">    -------</span>
</span><span id="line-451"><span class="sd">    DataFrame (default) or ndarray (i</span>
</span><span id="line-452"><span class="sd">        If return_separate_X_and_y then a tuple containing a DataFrame and a</span>
</span><span id="line-453"><span class="sd">        numpy array containing the relevant time-series and corresponding</span>
</span><span id="line-454"><span class="sd">        class values.</span>
</span><span id="line-455"><span class="sd">    DataFrame</span>
</span><span id="line-456"><span class="sd">        If not return_separate_X_and_y then a single DataFrame containing</span>
</span><span id="line-457"><span class="sd">        all time-series and (if relevant) a column &quot;class_vals&quot; the</span>
</span><span id="line-458"><span class="sd">        associated class values.</span>
</span><span id="line-459"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-460">    <span class="c1"># Initialize flags and variables used when parsing the file</span>
</span><span id="line-461">    <span class="n">metadata_started</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-462">    <span class="n">data_started</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-463">
</span><span id="line-464">    <span class="n">has_problem_name_tag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-465">    <span class="n">has_timestamps_tag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-466">    <span class="n">has_univariate_tag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-467">    <span class="n">has_class_labels_tag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-468">    <span class="n">has_data_tag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-469">
</span><span id="line-470">    <span class="n">previous_timestamp_was_int</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-471">    <span class="n">prev_timestamp_was_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-472">    <span class="n">num_dimensions</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-473">    <span class="n">is_first_case</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-474">    <span class="n">instance_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-475">    <span class="n">class_val_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-476">    <span class="n">line_num</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-477">    <span class="c1"># Parse the file</span>
</span><span id="line-478">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_file_path_and_name</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="line-479">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
</span><span id="line-480">            <span class="c1"># Strip white space from start/end of line and change to</span>
</span><span id="line-481">            <span class="c1"># lowercase for use below</span>
</span><span id="line-482">            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="line-483">            <span class="c1"># Empty lines are valid at any point in a file</span>
</span><span id="line-484">            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
</span><span id="line-485">                <span class="c1"># Check if this line contains metadata</span>
</span><span id="line-486">                <span class="c1"># Please note that even though metadata is stored in this</span>
</span><span id="line-487">                <span class="c1"># function it is not currently published externally</span>
</span><span id="line-488">                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@problemname&quot;</span><span class="p">):</span>
</span><span id="line-489">                    <span class="c1"># Check that the data has not started</span>
</span><span id="line-490">                    <span class="k">if</span> <span class="n">data_started</span><span class="p">:</span>
</span><span id="line-491">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;metadata must come before data&quot;</span><span class="p">)</span>
</span><span id="line-492">                    <span class="c1"># Check that the associated value is valid</span>
</span><span id="line-493">                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="line-494">                    <span class="n">token_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span id="line-495">                    <span class="k">if</span> <span class="n">token_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-496">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;problemname tag requires an associated value&quot;</span><span class="p">)</span>
</span><span id="line-497">                    <span class="c1"># problem_name = line[len(&quot;@problemname&quot;) + 1:]</span>
</span><span id="line-498">                    <span class="n">has_problem_name_tag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-499">                    <span class="n">metadata_started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-500">                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@timestamps&quot;</span><span class="p">):</span>
</span><span id="line-501">                    <span class="c1"># Check that the data has not started</span>
</span><span id="line-502">                    <span class="k">if</span> <span class="n">data_started</span><span class="p">:</span>
</span><span id="line-503">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;metadata must come before data&quot;</span><span class="p">)</span>
</span><span id="line-504">                    <span class="c1"># Check that the associated value is valid</span>
</span><span id="line-505">                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="line-506">                    <span class="n">token_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span id="line-507">                    <span class="k">if</span> <span class="n">token_len</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="line-508">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;timestamps tag requires an associated Boolean value&quot;</span><span class="p">)</span>
</span><span id="line-509">                    <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
</span><span id="line-510">                        <span class="n">timestamps</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-511">                    <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
</span><span id="line-512">                        <span class="n">timestamps</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-513">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-514">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;invalid timestamps value&quot;</span><span class="p">)</span>
</span><span id="line-515">                    <span class="n">has_timestamps_tag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-516">                    <span class="n">metadata_started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-517">                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@univariate&quot;</span><span class="p">):</span>
</span><span id="line-518">                    <span class="c1"># Check that the data has not started</span>
</span><span id="line-519">                    <span class="k">if</span> <span class="n">data_started</span><span class="p">:</span>
</span><span id="line-520">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;metadata must come before data&quot;</span><span class="p">)</span>
</span><span id="line-521">                    <span class="c1"># Check that the associated value is valid</span>
</span><span id="line-522">                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="line-523">                    <span class="n">token_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span id="line-524">                    <span class="k">if</span> <span class="n">token_len</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="line-525">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;univariate tag requires an associated Boolean  value&quot;</span><span class="p">)</span>
</span><span id="line-526">                    <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
</span><span id="line-527">                        <span class="c1"># univariate = True</span>
</span><span id="line-528">                        <span class="k">pass</span>
</span><span id="line-529">                    <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
</span><span id="line-530">                        <span class="c1"># univariate = False</span>
</span><span id="line-531">                        <span class="k">pass</span>
</span><span id="line-532">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-533">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;invalid univariate value&quot;</span><span class="p">)</span>
</span><span id="line-534">                    <span class="n">has_univariate_tag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-535">                    <span class="n">metadata_started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-536">                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@classlabel&quot;</span><span class="p">):</span>
</span><span id="line-537">                    <span class="c1"># Check that the data has not started</span>
</span><span id="line-538">                    <span class="k">if</span> <span class="n">data_started</span><span class="p">:</span>
</span><span id="line-539">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;metadata must come before data&quot;</span><span class="p">)</span>
</span><span id="line-540">                    <span class="c1"># Check that the associated value is valid</span>
</span><span id="line-541">                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="line-542">                    <span class="n">token_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span id="line-543">                    <span class="k">if</span> <span class="n">token_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-544">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;classlabel tag requires an associated Boolean  value&quot;</span><span class="p">)</span>
</span><span id="line-545">                    <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
</span><span id="line-546">                        <span class="n">class_labels</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-547">                    <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
</span><span id="line-548">                        <span class="n">class_labels</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-549">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-550">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;invalid classLabel value&quot;</span><span class="p">)</span>
</span><span id="line-551">                    <span class="c1"># Check if we have any associated class values</span>
</span><span id="line-552">                    <span class="k">if</span> <span class="n">token_len</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-553">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;if the classlabel tag is true then class values must be supplied&quot;</span><span class="p">)</span>
</span><span id="line-554">                    <span class="n">has_class_labels_tag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-555">                    <span class="n">class_label_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
</span><span id="line-556">                    <span class="n">metadata_started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-557">                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@targetlabel&quot;</span><span class="p">):</span>
</span><span id="line-558">                    <span class="k">if</span> <span class="n">data_started</span><span class="p">:</span>
</span><span id="line-559">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;metadata must come before data&quot;</span><span class="p">)</span>
</span><span id="line-560">                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="line-561">                    <span class="n">token_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span id="line-562">                    <span class="k">if</span> <span class="n">token_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-563">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;targetlabel tag requires an associated Boolean value&quot;</span><span class="p">)</span>
</span><span id="line-564">                    <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
</span><span id="line-565">                        <span class="n">class_labels</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-566">                    <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
</span><span id="line-567">                        <span class="n">class_labels</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-568">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-569">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;invalid targetlabel value&quot;</span><span class="p">)</span>
</span><span id="line-570">                    <span class="k">if</span> <span class="n">token_len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="line-571">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-572">                            <span class="s2">&quot;targetlabel tag should not be accompanied with info &quot;</span>
</span><span id="line-573">                            <span class="s2">&quot;apart from true/false, but found &quot;</span>
</span><span id="line-574">                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tokens</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="line-575">                        <span class="p">)</span>
</span><span id="line-576">                    <span class="n">has_class_labels_tag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-577">                    <span class="n">metadata_started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-578">                <span class="c1"># Check if this line contains the start of data</span>
</span><span id="line-579">                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@data&quot;</span><span class="p">):</span>
</span><span id="line-580">                    <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;@data&quot;</span><span class="p">:</span>
</span><span id="line-581">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;data tag should not have an associated value&quot;</span><span class="p">)</span>
</span><span id="line-582">                    <span class="k">if</span> <span class="n">data_started</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metadata_started</span><span class="p">:</span>
</span><span id="line-583">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;metadata must come before data&quot;</span><span class="p">)</span>
</span><span id="line-584">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-585">                        <span class="n">has_data_tag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-586">                        <span class="n">data_started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-587">                <span class="c1"># If the &#39;data tag has been found then metadata has been</span>
</span><span id="line-588">                <span class="c1"># parsed and data can be loaded</span>
</span><span id="line-589">                <span class="k">elif</span> <span class="n">data_started</span><span class="p">:</span>
</span><span id="line-590">                    <span class="c1"># Check that a full set of metadata has been provided</span>
</span><span id="line-591">                    <span class="k">if</span> <span class="p">(</span>
</span><span id="line-592">                        <span class="ow">not</span> <span class="n">has_problem_name_tag</span>
</span><span id="line-593">                        <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_timestamps_tag</span>
</span><span id="line-594">                        <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_univariate_tag</span>
</span><span id="line-595">                        <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_class_labels_tag</span>
</span><span id="line-596">                        <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_data_tag</span>
</span><span id="line-597">                    <span class="p">):</span>
</span><span id="line-598">                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;a full set of metadata has not been provided before the data&quot;</span><span class="p">)</span>
</span><span id="line-599">                    <span class="c1"># Replace any missing values with the value specified</span>
</span><span id="line-600">                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">replace_missing_vals_with</span><span class="p">)</span>
</span><span id="line-601">                    <span class="c1"># Check if we are dealing with data that has timestamps</span>
</span><span id="line-602">                    <span class="k">if</span> <span class="n">timestamps</span><span class="p">:</span>
</span><span id="line-603">                        <span class="c1"># We&#39;re dealing with timestamps so cannot just split</span>
</span><span id="line-604">                        <span class="c1"># line on &#39;:&#39; as timestamps may contain one</span>
</span><span id="line-605">                        <span class="n">has_another_value</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-606">                        <span class="n">has_another_dimension</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-607">                        <span class="n">timestamp_for_dim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-608">                        <span class="n">values_for_dimension</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-609">                        <span class="n">this_line_num_dim</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-610">                        <span class="n">line_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="line-611">                        <span class="n">char_num</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-612">                        <span class="k">while</span> <span class="n">char_num</span> <span class="o">&lt;</span> <span class="n">line_len</span><span class="p">:</span>
</span><span id="line-613">                            <span class="c1"># Move through any spaces</span>
</span><span id="line-614">                            <span class="k">while</span> <span class="n">char_num</span> <span class="o">&lt;</span> <span class="n">line_len</span> <span class="ow">and</span> <span class="nb">str</span><span class="o">.</span><span class="n">isspace</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">]):</span>
</span><span id="line-615">                                <span class="n">char_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-616">                            <span class="c1"># See if there is any more data to read in or if</span>
</span><span id="line-617">                            <span class="c1"># we should validate that read thus far</span>
</span><span id="line-618">                            <span class="k">if</span> <span class="n">char_num</span> <span class="o">&lt;</span> <span class="n">line_len</span><span class="p">:</span>
</span><span id="line-619">                                <span class="c1"># See if we have an empty dimension (i.e. no</span>
</span><span id="line-620">                                <span class="c1"># values)</span>
</span><span id="line-621">                                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;:&quot;</span><span class="p">:</span>
</span><span id="line-622">                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="line-623">                                        <span class="n">instance_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
</span><span id="line-624">                                    <span class="n">instance_list</span><span class="p">[</span><span class="n">this_line_num_dim</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">))</span>
</span><span id="line-625">                                    <span class="n">this_line_num_dim</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-626">                                    <span class="n">has_another_value</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-627">                                    <span class="n">has_another_dimension</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-628">                                    <span class="n">timestamp_for_dim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-629">                                    <span class="n">values_for_dimension</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-630">                                    <span class="n">char_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-631">                                <span class="k">else</span><span class="p">:</span>
</span><span id="line-632">                                    <span class="c1"># Check if we have reached a class label</span>
</span><span id="line-633">                                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;(&quot;</span> <span class="ow">and</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-634">                                        <span class="n">class_val</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="line-635">                                        <span class="k">if</span> <span class="n">class_val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_label_list</span><span class="p">:</span>
</span><span id="line-636">                                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-637">                                                <span class="s2">&quot;the class value &#39;&quot;</span>
</span><span id="line-638">                                                <span class="o">+</span> <span class="n">class_val</span>
</span><span id="line-639">                                                <span class="o">+</span> <span class="s2">&quot;&#39; on line &quot;</span>
</span><span id="line-640">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-641">                                                <span class="o">+</span> <span class="s2">&quot; is not &quot;</span>
</span><span id="line-642">                                                <span class="s2">&quot;valid&quot;</span>
</span><span id="line-643">                                            <span class="p">)</span>
</span><span id="line-644">                                        <span class="n">class_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_val</span><span class="p">)</span>
</span><span id="line-645">                                        <span class="n">char_num</span> <span class="o">=</span> <span class="n">line_len</span>
</span><span id="line-646">                                        <span class="n">has_another_value</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-647">                                        <span class="n">has_another_dimension</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-648">                                        <span class="n">timestamp_for_dim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-649">                                        <span class="n">values_for_dimension</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-650">                                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-651">                                        <span class="c1"># Read in the data contained within</span>
</span><span id="line-652">                                        <span class="c1"># the next tuple</span>
</span><span id="line-653">                                        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;(&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-654">                                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-655">                                                <span class="s2">&quot;dimension &quot;</span>
</span><span id="line-656">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-657">                                                <span class="o">+</span> <span class="s2">&quot; on line &quot;</span>
</span><span id="line-658">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-659">                                                <span class="o">+</span> <span class="s2">&quot; does &quot;</span>
</span><span id="line-660">                                                <span class="s2">&quot;not &quot;</span>
</span><span id="line-661">                                                <span class="s2">&quot;start &quot;</span>
</span><span id="line-662">                                                <span class="s2">&quot;with a &quot;</span>
</span><span id="line-663">                                                <span class="s2">&quot;&#39;(&#39;&quot;</span>
</span><span id="line-664">                                            <span class="p">)</span>
</span><span id="line-665">                                        <span class="n">char_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-666">                                        <span class="n">tuple_data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="line-667">                                        <span class="k">while</span> <span class="n">char_num</span> <span class="o">&lt;</span> <span class="n">line_len</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;)&quot;</span><span class="p">:</span>
</span><span id="line-668">                                            <span class="n">tuple_data</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">]</span>
</span><span id="line-669">                                            <span class="n">char_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-670">                                        <span class="k">if</span> <span class="n">char_num</span> <span class="o">&gt;=</span> <span class="n">line_len</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;)&quot;</span><span class="p">:</span>
</span><span id="line-671">                                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-672">                                                <span class="s2">&quot;dimension &quot;</span>
</span><span id="line-673">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-674">                                                <span class="o">+</span> <span class="s2">&quot; on line &quot;</span>
</span><span id="line-675">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-676">                                                <span class="o">+</span> <span class="s2">&quot; does &quot;</span>
</span><span id="line-677">                                                <span class="s2">&quot;not end&quot;</span>
</span><span id="line-678">                                                <span class="s2">&quot; with a &quot;</span>
</span><span id="line-679">                                                <span class="s2">&quot;&#39;)&#39;&quot;</span>
</span><span id="line-680">                                            <span class="p">)</span>
</span><span id="line-681">                                        <span class="c1"># Read in any spaces immediately</span>
</span><span id="line-682">                                        <span class="c1"># after the current tuple</span>
</span><span id="line-683">                                        <span class="n">char_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-684">                                        <span class="k">while</span> <span class="n">char_num</span> <span class="o">&lt;</span> <span class="n">line_len</span> <span class="ow">and</span> <span class="nb">str</span><span class="o">.</span><span class="n">isspace</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">]):</span>
</span><span id="line-685">                                            <span class="n">char_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-686">
</span><span id="line-687">                                        <span class="c1"># Check if there is another value or</span>
</span><span id="line-688">                                        <span class="c1"># dimension to process after this tuple</span>
</span><span id="line-689">                                        <span class="k">if</span> <span class="n">char_num</span> <span class="o">&gt;=</span> <span class="n">line_len</span><span class="p">:</span>
</span><span id="line-690">                                            <span class="n">has_another_value</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-691">                                            <span class="n">has_another_dimension</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-692">                                        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span><span class="p">:</span>
</span><span id="line-693">                                            <span class="n">has_another_value</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-694">                                            <span class="n">has_another_dimension</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-695">                                        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="n">char_num</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;:&quot;</span><span class="p">:</span>
</span><span id="line-696">                                            <span class="n">has_another_value</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-697">                                            <span class="n">has_another_dimension</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-698">                                        <span class="n">char_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-699">                                        <span class="c1"># Get the numeric value for the</span>
</span><span id="line-700">                                        <span class="c1"># tuple by reading from the end of</span>
</span><span id="line-701">                                        <span class="c1"># the tuple data backwards to the</span>
</span><span id="line-702">                                        <span class="c1"># last comma</span>
</span><span id="line-703">                                        <span class="n">last_comma_index</span> <span class="o">=</span> <span class="n">tuple_data</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="line-704">                                        <span class="k">if</span> <span class="n">last_comma_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="line-705">                                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-706">                                                <span class="s2">&quot;dimension &quot;</span>
</span><span id="line-707">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-708">                                                <span class="o">+</span> <span class="s2">&quot; on line &quot;</span>
</span><span id="line-709">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-710">                                                <span class="o">+</span> <span class="s2">&quot; contains a tuple that has &quot;</span>
</span><span id="line-711">                                                <span class="s2">&quot;no comma inside of it&quot;</span>
</span><span id="line-712">                                            <span class="p">)</span>
</span><span id="line-713">                                        <span class="k">try</span><span class="p">:</span>
</span><span id="line-714">                                            <span class="n">value</span> <span class="o">=</span> <span class="n">tuple_data</span><span class="p">[</span><span class="n">last_comma_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
</span><span id="line-715">                                            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="line-716">                                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="line-717">                                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-718">                                                <span class="s2">&quot;dimension &quot;</span>
</span><span id="line-719">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-720">                                                <span class="o">+</span> <span class="s2">&quot; on line &quot;</span>
</span><span id="line-721">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-722">                                                <span class="o">+</span> <span class="s2">&quot; contains a tuple that does &quot;</span>
</span><span id="line-723">                                                <span class="s2">&quot;not have a valid numeric &quot;</span>
</span><span id="line-724">                                                <span class="s2">&quot;value&quot;</span>
</span><span id="line-725">                                            <span class="p">)</span>
</span><span id="line-726">                                        <span class="c1"># Check the type of timestamp that</span>
</span><span id="line-727">                                        <span class="c1"># we have</span>
</span><span id="line-728">                                        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">tuple_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">last_comma_index</span><span class="p">]</span>
</span><span id="line-729">                                        <span class="k">try</span><span class="p">:</span>
</span><span id="line-730">                                            <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
</span><span id="line-731">                                            <span class="n">timestamp_is_int</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-732">                                            <span class="n">timestamp_is_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-733">                                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="line-734">                                            <span class="n">timestamp_is_int</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-735">                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp_is_int</span><span class="p">:</span>
</span><span id="line-736">                                            <span class="k">try</span><span class="p">:</span>
</span><span id="line-737">                                                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="line-738">                                                <span class="n">timestamp_is_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-739">                                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="line-740">                                                <span class="n">timestamp_is_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-741">                                        <span class="c1"># Make sure that the timestamps in</span>
</span><span id="line-742">                                        <span class="c1"># the file (not just this dimension</span>
</span><span id="line-743">                                        <span class="c1"># or case) are consistent</span>
</span><span id="line-744">                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp_is_timestamp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">timestamp_is_int</span><span class="p">:</span>
</span><span id="line-745">                                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-746">                                                <span class="s2">&quot;dimension &quot;</span>
</span><span id="line-747">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-748">                                                <span class="o">+</span> <span class="s2">&quot; on line &quot;</span>
</span><span id="line-749">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-750">                                                <span class="o">+</span> <span class="s2">&quot; contains a tuple that &quot;</span>
</span><span id="line-751">                                                <span class="s2">&quot;has an invalid timestamp &#39;&quot;</span> <span class="o">+</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
</span><span id="line-752">                                            <span class="p">)</span>
</span><span id="line-753">                                        <span class="k">if</span> <span class="p">(</span>
</span><span id="line-754">                                            <span class="n">previous_timestamp_was_int</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="line-755">                                            <span class="ow">and</span> <span class="n">previous_timestamp_was_int</span>
</span><span id="line-756">                                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">timestamp_is_int</span>
</span><span id="line-757">                                        <span class="p">):</span>
</span><span id="line-758">                                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-759">                                                <span class="s2">&quot;dimension &quot;</span>
</span><span id="line-760">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-761">                                                <span class="o">+</span> <span class="s2">&quot; on line &quot;</span>
</span><span id="line-762">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-763">                                                <span class="o">+</span> <span class="s2">&quot; contains tuples where the &quot;</span>
</span><span id="line-764">                                                <span class="s2">&quot;timestamp format is &quot;</span>
</span><span id="line-765">                                                <span class="s2">&quot;inconsistent&quot;</span>
</span><span id="line-766">                                            <span class="p">)</span>
</span><span id="line-767">                                        <span class="k">if</span> <span class="p">(</span>
</span><span id="line-768">                                            <span class="n">prev_timestamp_was_timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="line-769">                                            <span class="ow">and</span> <span class="n">prev_timestamp_was_timestamp</span>
</span><span id="line-770">                                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">timestamp_is_timestamp</span>
</span><span id="line-771">                                        <span class="p">):</span>
</span><span id="line-772">                                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-773">                                                <span class="s2">&quot;dimension &quot;</span>
</span><span id="line-774">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-775">                                                <span class="o">+</span> <span class="s2">&quot; on line &quot;</span>
</span><span id="line-776">                                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-777">                                                <span class="o">+</span> <span class="s2">&quot; contains tuples where the &quot;</span>
</span><span id="line-778">                                                <span class="s2">&quot;timestamp format is &quot;</span>
</span><span id="line-779">                                                <span class="s2">&quot;inconsistent&quot;</span>
</span><span id="line-780">                                            <span class="p">)</span>
</span><span id="line-781">                                        <span class="c1"># Store the values</span>
</span><span id="line-782">                                        <span class="n">timestamp_for_dim</span> <span class="o">+=</span> <span class="p">[</span><span class="n">timestamp</span><span class="p">]</span>
</span><span id="line-783">                                        <span class="n">values_for_dimension</span> <span class="o">+=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
</span><span id="line-784">                                        <span class="c1">#  If this was our first tuple then</span>
</span><span id="line-785">                                        <span class="c1">#  we store the type of timestamp we</span>
</span><span id="line-786">                                        <span class="c1">#  had</span>
</span><span id="line-787">                                        <span class="k">if</span> <span class="n">prev_timestamp_was_timestamp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">timestamp_is_timestamp</span><span class="p">:</span>
</span><span id="line-788">                                            <span class="n">prev_timestamp_was_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-789">                                            <span class="n">previous_timestamp_was_int</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-790">
</span><span id="line-791">                                        <span class="k">if</span> <span class="n">previous_timestamp_was_int</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">timestamp_is_int</span><span class="p">:</span>
</span><span id="line-792">                                            <span class="n">prev_timestamp_was_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-793">                                            <span class="n">previous_timestamp_was_int</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-794">                                        <span class="c1"># See if we should add the data for</span>
</span><span id="line-795">                                        <span class="c1"># this dimension</span>
</span><span id="line-796">                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_another_value</span><span class="p">:</span>
</span><span id="line-797">                                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="line-798">                                                <span class="n">instance_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
</span><span id="line-799">
</span><span id="line-800">                                            <span class="k">if</span> <span class="n">timestamp_is_timestamp</span><span class="p">:</span>
</span><span id="line-801">                                                <span class="n">timestamp_for_dim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">timestamp_for_dim</span><span class="p">)</span>
</span><span id="line-802">
</span><span id="line-803">                                            <span class="n">instance_list</span><span class="p">[</span><span class="n">this_line_num_dim</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="line-804">                                                <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
</span><span id="line-805">                                                    <span class="n">index</span><span class="o">=</span><span class="n">timestamp_for_dim</span><span class="p">,</span>
</span><span id="line-806">                                                    <span class="n">data</span><span class="o">=</span><span class="n">values_for_dimension</span><span class="p">,</span>
</span><span id="line-807">                                                <span class="p">)</span>
</span><span id="line-808">                                            <span class="p">)</span>
</span><span id="line-809">                                            <span class="n">this_line_num_dim</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-810">                                            <span class="n">timestamp_for_dim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-811">                                            <span class="n">values_for_dimension</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-812">                            <span class="k">elif</span> <span class="n">has_another_value</span><span class="p">:</span>
</span><span id="line-813">                                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-814">                                    <span class="s2">&quot;dimension &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; on &quot;</span>
</span><span id="line-815">                                    <span class="s2">&quot;line &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ends with a &#39;,&#39; that &quot;</span>
</span><span id="line-816">                                    <span class="s2">&quot;is not followed by &quot;</span>
</span><span id="line-817">                                    <span class="s2">&quot;another tuple&quot;</span>
</span><span id="line-818">                                <span class="p">)</span>
</span><span id="line-819">                            <span class="k">elif</span> <span class="n">has_another_dimension</span> <span class="ow">and</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-820">                                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-821">                                    <span class="s2">&quot;dimension &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; on &quot;</span>
</span><span id="line-822">                                    <span class="s2">&quot;line &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ends with a &#39;:&#39; while &quot;</span>
</span><span id="line-823">                                    <span class="s2">&quot;it should list a class &quot;</span>
</span><span id="line-824">                                    <span class="s2">&quot;value&quot;</span>
</span><span id="line-825">                                <span class="p">)</span>
</span><span id="line-826">                            <span class="k">elif</span> <span class="n">has_another_dimension</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-827">                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="line-828">                                    <span class="n">instance_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
</span><span id="line-829">                                <span class="n">instance_list</span><span class="p">[</span><span class="n">this_line_num_dim</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</span><span id="line-830">                                <span class="n">this_line_num_dim</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-831">                                <span class="n">num_dimensions</span> <span class="o">=</span> <span class="n">this_line_num_dim</span>
</span><span id="line-832">                            <span class="c1"># If this is the 1st line of data we have seen</span>
</span><span id="line-833">                            <span class="c1"># then note the dimensions</span>
</span><span id="line-834">                            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_another_value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_another_dimension</span><span class="p">:</span>
</span><span id="line-835">                                <span class="k">if</span> <span class="n">num_dimensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-836">                                    <span class="n">num_dimensions</span> <span class="o">=</span> <span class="n">this_line_num_dim</span>
</span><span id="line-837">                                <span class="k">if</span> <span class="n">num_dimensions</span> <span class="o">!=</span> <span class="n">this_line_num_dim</span><span class="p">:</span>
</span><span id="line-838">                                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-839">                                        <span class="s2">&quot;line &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; does not have the &quot;</span>
</span><span id="line-840">                                        <span class="s2">&quot;same number of &quot;</span>
</span><span id="line-841">                                        <span class="s2">&quot;dimensions as the &quot;</span>
</span><span id="line-842">                                        <span class="s2">&quot;previous line of &quot;</span>
</span><span id="line-843">                                        <span class="s2">&quot;data&quot;</span>
</span><span id="line-844">                                    <span class="p">)</span>
</span><span id="line-845">                        <span class="c1"># Check that we are not expecting some more data,</span>
</span><span id="line-846">                        <span class="c1"># and if not, store that processed above</span>
</span><span id="line-847">                        <span class="k">if</span> <span class="n">has_another_value</span><span class="p">:</span>
</span><span id="line-848">                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-849">                                <span class="s2">&quot;dimension &quot;</span>
</span><span id="line-850">                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-851">                                <span class="o">+</span> <span class="s2">&quot; on line &quot;</span>
</span><span id="line-852">                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-853">                                <span class="o">+</span> <span class="s2">&quot; ends with a &#39;,&#39; that is &quot;</span>
</span><span id="line-854">                                <span class="s2">&quot;not followed by another &quot;</span>
</span><span id="line-855">                                <span class="s2">&quot;tuple&quot;</span>
</span><span id="line-856">                            <span class="p">)</span>
</span><span id="line-857">                        <span class="k">elif</span> <span class="n">has_another_dimension</span> <span class="ow">and</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-858">                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-859">                                <span class="s2">&quot;dimension &quot;</span>
</span><span id="line-860">                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-861">                                <span class="o">+</span> <span class="s2">&quot; on line &quot;</span>
</span><span id="line-862">                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="line-863">                                <span class="o">+</span> <span class="s2">&quot; ends with a &#39;:&#39; while it &quot;</span>
</span><span id="line-864">                                <span class="s2">&quot;should list a class value&quot;</span>
</span><span id="line-865">                            <span class="p">)</span>
</span><span id="line-866">                        <span class="k">elif</span> <span class="n">has_another_dimension</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-867">                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">this_line_num_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="line-868">                                <span class="n">instance_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
</span><span id="line-869">                            <span class="n">instance_list</span><span class="p">[</span><span class="n">this_line_num_dim</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">))</span>
</span><span id="line-870">                            <span class="n">this_line_num_dim</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-871">                            <span class="n">num_dimensions</span> <span class="o">=</span> <span class="n">this_line_num_dim</span>
</span><span id="line-872">                        <span class="c1"># If this is the 1st line of data we have seen then</span>
</span><span id="line-873">                        <span class="c1"># note the dimensions</span>
</span><span id="line-874">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_another_value</span> <span class="ow">and</span> <span class="n">num_dimensions</span> <span class="o">!=</span> <span class="n">this_line_num_dim</span><span class="p">:</span>
</span><span id="line-875">                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-876">                                <span class="s2">&quot;line &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; does not have the same &quot;</span>
</span><span id="line-877">                                <span class="s2">&quot;number of dimensions as the &quot;</span>
</span><span id="line-878">                                <span class="s2">&quot;previous line of data&quot;</span>
</span><span id="line-879">                            <span class="p">)</span>
</span><span id="line-880">                        <span class="c1"># Check if we should have class values, and if so</span>
</span><span id="line-881">                        <span class="c1"># that they are contained in those listed in the</span>
</span><span id="line-882">                        <span class="c1"># metadata</span>
</span><span id="line-883">                        <span class="k">if</span> <span class="n">class_labels</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_val_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-884">                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;the cases have no associated class values&quot;</span><span class="p">)</span>
</span><span id="line-885">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-886">                        <span class="n">dimensions</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span id="line-887">                        <span class="c1"># If first row then note the number of dimensions (</span>
</span><span id="line-888">                        <span class="c1"># that must be the same for all cases)</span>
</span><span id="line-889">                        <span class="k">if</span> <span class="n">is_first_case</span><span class="p">:</span>
</span><span id="line-890">                            <span class="n">num_dimensions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span>
</span><span id="line-891">                            <span class="k">if</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-892">                                <span class="n">num_dimensions</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="line-893">                            <span class="k">for</span> <span class="n">_dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_dimensions</span><span class="p">):</span>
</span><span id="line-894">                                <span class="n">instance_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
</span><span id="line-895">                            <span class="n">is_first_case</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-896">                        <span class="c1"># See how many dimensions that the case whose data</span>
</span><span id="line-897">                        <span class="c1"># in represented in this line has</span>
</span><span id="line-898">                        <span class="n">this_line_num_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span>
</span><span id="line-899">                        <span class="k">if</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-900">                            <span class="n">this_line_num_dim</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="line-901">                        <span class="c1"># All dimensions should be included for all series,</span>
</span><span id="line-902">                        <span class="c1"># even if they are empty</span>
</span><span id="line-903">                        <span class="k">if</span> <span class="n">this_line_num_dim</span> <span class="o">!=</span> <span class="n">num_dimensions</span><span class="p">:</span>
</span><span id="line-904">                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
</span><span id="line-905">                                <span class="s2">&quot;inconsistent number of dimensions. &quot;</span>
</span><span id="line-906">                                <span class="s2">&quot;Expecting &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_dimensions</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; but have read &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_line_num_dim</span><span class="p">)</span>
</span><span id="line-907">                            <span class="p">)</span>
</span><span id="line-908">                        <span class="c1"># Process the data for each dimension</span>
</span><span id="line-909">                        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_dimensions</span><span class="p">):</span>
</span><span id="line-910">                            <span class="n">dimension</span> <span class="o">=</span> <span class="n">dimensions</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="line-911">
</span><span id="line-912">                            <span class="k">if</span> <span class="n">dimension</span><span class="p">:</span>
</span><span id="line-913">                                <span class="n">data_series</span> <span class="o">=</span> <span class="n">dimension</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="line-914">                                <span class="n">data_series</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_series</span><span class="p">]</span>
</span><span id="line-915">                                <span class="n">instance_list</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data_series</span><span class="p">))</span>
</span><span id="line-916">                            <span class="k">else</span><span class="p">:</span>
</span><span id="line-917">                                <span class="n">instance_list</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">))</span>
</span><span id="line-918">                        <span class="k">if</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-919">                            <span class="n">class_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="n">num_dimensions</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="line-920">            <span class="n">line_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-921">    <span class="c1"># Check that the file was not empty</span>
</span><span id="line-922">    <span class="k">if</span> <span class="n">line_num</span><span class="p">:</span>
</span><span id="line-923">        <span class="c1"># Check that the file contained both metadata and data</span>
</span><span id="line-924">        <span class="k">if</span> <span class="n">metadata_started</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="line-925">            <span class="n">has_problem_name_tag</span>
</span><span id="line-926">            <span class="ow">and</span> <span class="n">has_timestamps_tag</span>
</span><span id="line-927">            <span class="ow">and</span> <span class="n">has_univariate_tag</span>
</span><span id="line-928">            <span class="ow">and</span> <span class="n">has_class_labels_tag</span>
</span><span id="line-929">            <span class="ow">and</span> <span class="n">has_data_tag</span>
</span><span id="line-930">        <span class="p">):</span>
</span><span id="line-931">            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;metadata incomplete&quot;</span><span class="p">)</span>
</span><span id="line-932">
</span><span id="line-933">        <span class="k">elif</span> <span class="n">metadata_started</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data_started</span><span class="p">:</span>
</span><span id="line-934">            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;file contained metadata but no data&quot;</span><span class="p">)</span>
</span><span id="line-935">
</span><span id="line-936">        <span class="k">elif</span> <span class="n">metadata_started</span> <span class="ow">and</span> <span class="n">data_started</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-937">            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;file contained metadata but no data&quot;</span><span class="p">)</span>
</span><span id="line-938">        <span class="c1"># Create a DataFrame from the data parsed above</span>
</span><span id="line-939">        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="line-940">        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_dimensions</span><span class="p">):</span>
</span><span id="line-941">            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dim_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="n">instance_list</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
</span><span id="line-942">        <span class="c1"># Check if we should return any associated class labels separately</span>
</span><span id="line-943">        <span class="k">if</span> <span class="n">class_labels</span><span class="p">:</span>
</span><span id="line-944">            <span class="k">if</span> <span class="n">return_separate_X_and_y</span><span class="p">:</span>
</span><span id="line-945">                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">class_val_list</span><span class="p">)</span>
</span><span id="line-946">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-947">                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;class_vals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">class_val_list</span><span class="p">)</span>
</span><span id="line-948">                <span class="k">return</span> <span class="n">data</span>
</span><span id="line-949">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-950">            <span class="k">return</span> <span class="n">data</span>
</span><span id="line-951">    <span class="k">else</span><span class="p">:</span>
</span><span id="line-952">        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;empty file&quot;</span><span class="p">)</span></div>

</span></code></pre></div>
    </div></div>
          </main>
        </div>
      </div><footer class="py-6 border-t border-border md:py-0">
    <div class="container flex flex-col items-center justify-between gap-4 md:h-24 md:flex-row">
      <div class="flex flex-col items-center gap-4 px-8 md:flex-row md:gap-2 md:px-0">
        <p class="text-sm leading-loose text-center text-muted-foreground md:text-left">Â© 2026&nbsp;Built with <a class="font-medium underline underline-offset-4"
    href="https://www.sphinx-doc.org"
    rel="noreferrer">Sphinx 9.0.4</a></p>
</div>
</div>
</footer>
    </div><button id="scrolltop"
        x-cloak
        @click="window.scrollTo({top: 0, behavior: 'smooth'})"
        class="fixed bottom-8 right-8 p-2 z-10 rounded-sm bg-gray-700 text-xs text-white transition-all duration-1000 hover:bg-gray-950 focus:bg-gray-950"
        :class="{'opacity-0 invisible' : !showScrollTop}"
>
  <svg xmlns="http://www.w3.org/2000/svg"
       height="14"
       viewBox="0 96 960 960"
       width="14"
       class="inline fill-current mb-[2px]"
       aria-hidden="true">
    <path d="M450 896V370L202 618l-42-42 320-320 320 320-42 42-248-248v526h-60Z" />
  </svg>
  Back to top
</button>
    
    <script src="../../../_static/documentation_options.js?v=c167d237"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script defer="defer" src="../../../_static/theme.js?v=582b20c5"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    
</body>

</html>